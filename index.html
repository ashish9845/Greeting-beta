<!DOCTYPE html>
<html lang="en" translate="no">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Media Player</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Load Dancing Script, Inter, and Tangerine fonts from Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400..700&family=Inter:wght@400;700&family=Tangerine:wght@400;700&display=swap"
        rel="stylesheet">

    <!-- Load Nepali Date Converter Library -->
    <script src="https://cdn.jsdelivr.net/npm/nepali-date-converter@3.3.1/dist/nepali-date-converter.umd.js">
    </script>

    <style>
        /* Apply custom background, text color, and Inter font for general text */
        body {
            background-color: #1C1B1F;
            color: #E6E1E5;
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
        }

        /* Custom style applied specifically to the Greeting Text */
        #greeting-text {
            font-family: 'Dancing Script', cursive;
            transition: all 0.7s ease-out;
            cursor: pointer;
        }

        /* Custom style applied specifically to the Quote Text */
        #quote-text {
            font-family: 'Tangerine', cursive;
            transition: all 0.7s ease-out;
            border-right: 0.15em solid transparent;
        }

        /* Positioning for elements when the card is active (Quote mode) */
        #time-display.active-state {
            font-size: 2.5rem;
            position: absolute;
            top: 2rem;
            left: 50%;
            transform: translateX(-50%);
            transition: all 1s ease-in-out;
        }

        /* New state for combined English date: hide it */
        #english-date-combined.active-state {
            opacity: 0;
            transform: translateY(-30px);
            pointer-events: none;
        }

        #quote-container.active-state {
            opacity: 1;
            transform: scale(1);
            pointer-events: auto;
            padding-top: 1.5rem;
            padding-bottom: 1.5rem;
        }

        /* Custom style for the BETA badge - Fixed to Top-Left */
        .beta-badge {
            position: fixed;
            top: 1rem;
            left: 1rem;
            background-color: #EF4444;
            color: white;
            padding: 0.25rem 0.75rem;
            font-size: 0.875rem;
            font-weight: bold;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            border-radius: 9999px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            z-index: 10;
        }

        .beta-badge:hover {
            background-color: #DC2626;
            transform: translateY(-1px);
        }

        /* Custom style for the Search Container - Fixed to Top-Right */
        .search-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 20;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-direction: column;
            align-items: flex-end;
        }

        /* Wrapper for input and button */
        .search-input-wrapper {
            display: flex;
            gap: 0.5rem;
        }

        .search-input {
            background-color: #1C1B1F;
            color: #E6E1E5;
            border: 1px solid #4B5563;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            width: 150px;
            transition: all 0.2s;
        }

        .search-input:focus {
            outline: none;
            border-color: #A78BFA;
            box-shadow: 0 0 0 3px rgba(167, 139, 250, 0.5);
            width: 200px;
        }

        .search-button {
            background-color: #A78BFA;
            color: white;
            padding: 0.5rem;
            border-radius: 9999px;
            transition: background-color 0.2s, transform 0.1s;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
        }

        .search-button:hover {
            background-color: #8B5CF6;
        }

        /* --- New Video Player Styles --- */
        #video-player-container {
            margin-top: 2rem;
            width: 90%;
            max-width: 900px;
            min-height: 400px;
            background-color: #1C1B1F;
            border-radius: 1rem;
            box-shadow: 0 0 40px rgba(167, 139, 250, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: #A78BFA;
            overflow: hidden;
            transition: all 0.5s ease-in-out;
            border: 2px solid #3730A3;
            position: relative;
        }

        #video-player-container iframe {
            width: 100%;
            height: 100%;
            border: none;
            display: block;
            position: absolute;
            top: 0;
            left: 0;
        }

        .video-placeholder-text {
            font-size: 1.5rem;
            font-weight: 600;
            padding: 2rem;
        }

        /* --- Suggestions List Styles --- */
        #suggestions-list {
            position: absolute;
            top: 45px;
            right: 0;
            width: 240px;
            /* Slightly wider to accommodate the thumbnail */
            max-height: 240px;
            overflow-y: auto;
            background-color: #2D2C31;
            border-radius: 0.5rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            list-style: none;
            padding: 0;
            margin: 0;
            z-index: 19;
            transition: opacity 0.3s ease;
            opacity: 0;
            pointer-events: none;
        }

        #suggestions-list.active {
            opacity: 1;
            pointer-events: auto;
        }

        .suggestion-item {
            padding: 0.5rem 1rem;
            cursor: pointer;
            color: #E6E1E5;
            font-size: 0.875rem;
            border-bottom: 1px solid #4B5563;
            display: flex;
            align-items: center;
            transition: background-color 0.1s;
        }

        .suggestion-item:hover {
            background-color: #4B5563;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-thumbnail {
            width: 40px;
            height: 25px;
            border-radius: 4px;
            object-fit: cover;
            margin-right: 0.75rem;
            background-color: #4B5563;
            /* Placeholder color */
        }

        .loading-suggestion {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            color: #A78BFA;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .spinner {
            border: 3px solid rgba(167, 139, 250, 0.1);
            border-left-color: #A78BFA;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 0.8s linear infinite;
            margin-right: 0.5rem;
        }
    </style>
</head>

<body class="flex flex-col items-center justify-center p-4">

    <!-- BETA Indicator Badge (Fixed Top-Left) -->
    <div id="beta-badge" class="beta-badge" onclick="showBetaModal(true)">BETA</div>

    <!-- Search Box Container (Fixed Top-Right) -->
    <div id="search-container" class="search-container">
        <!-- Input and Button Wrapper -->
        <div class="search-input-wrapper">
            <input type="text" id="search-input" placeholder="Search Movie/Series..." class="search-input"
                onkeydown="handleKeydown(event)" oninput="handleInput()">
            <button id="search-button" class="search-button" onclick="handleSearch()">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                    xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
            </button>
        </div>
        <!-- Suggestions List -->
        <ul id="suggestions-list"></ul>
    </div>

    <!-- Main Content Card -->
    <div id="main-card"
        class="bg-[#2D2C31] p-8 md:p-12 lg:p-16 rounded-3xl shadow-2xl w-full max-w-4xl space-y-8 relative overflow-hidden transform transition duration-500 hover:shadow-[0_0_50px_rgba(108,92,231,0.5)]">

        <!-- Header: Dynamic Date and Time -->
        <header id="header-content" class="text-center space-y-2 transition-all duration-700 pt-0 mt-0">
            <!-- Combined English Date: Eg: Friday, Nov 28, 2025 -->
            <p id="english-date-combined"
                class="text-lg md:text-xl text-yellow-300 font-semibold transition-all duration-700">
                Loading English Date...
            </p>

            <!-- Time Display -->
            <p id="time-display"
                class="text-4xl md:text-6xl font-extrabold tracking-wider text-purple-400 transition-all duration-700">
                Loading...
            </p>

            <!-- Nepali Date -->
            <p id="nepali-date" class="text-md md:text-lg text-yellow-500 transition-all duration-700">
                Loading Nepali Date...
            </p>

            <!-- Separator Line between time block and greeting block -->
            <div id="header-separator"
                class="h-px bg-gray-700 w-full mx-auto mt-6 mb-6 transition-opacity duration-500 opacity-0"></div>
        </header>

        <!-- Dynamic Greeting and Quote Section -->
        <main id="main-content" class="text-center transition-all duration-700">
            <!-- Greeting (Clickable to toggle quote rotation) -->
            <h1 id="greeting-text" onclick="toggleQuoteRotation()"
                class="text-4xl md:text-7xl font-bold text-white mb-4 transition-all">
                Loading...
            </h1>

            <!-- Quote Container - Hidden/Scaled down initially -->
            <div id="quote-container" class="opacity-0 scale-90 pointer-events-none transition-all duration-700 mt-6">
                <blockquote class="italic text-gray-400">
                    <p id="quote-text" class="text-2xl md:text-4xl leading-snug">
                        "Click the greeting above to start the inspiration."
                    </p>
                    <cite id="quote-author" class="block text-lg md:text-xl mt-4 text-purple-300 transition-all">
                        â€” Ready
                    </cite>
                </blockquote>
            </div>
        </main>
    </div>

    <!-- Video Player Container (NEW ELEMENT) -->
    <div id="video-player-container" class="lg:h-[500px] h-[300px]">
        <p class="video-placeholder-text">Search for a Movie or TV Series to play it here.</p>
    </div>

    <!-- Social Media Icons Container -->
    <div id="social-icons" class="fixed bottom-6 right-4 flex space-x-4 z-20 transition-all duration-500">
        <!-- Instagram Icon -->
        <a href="https://www.instagram.com/_aashish_dahal/" target="_blank" title="Instagram"
            class="text-gray-300 hover:text-pink-500 transition-colors">
            <svg class="w-7 h-7" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect width="20" height="20" x="2" y="2" rx="5" ry="5" />
                <path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z" />
                <line x1="17.5" x2="17.5" y1="6.5" y2="6.5" />
            </svg>
        </a>

        <!-- Facebook Icon -->
        <a href="https://www.facebook.com/ashish.dahal.555186" target="_blank" title="Facebook"
            class="text-gray-300 hover:text-blue-600 transition-colors">
            <svg class="w-7 h-7" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z" />
            </svg>
        </a>

        <!-- WhatsApp Icon -->
        <a href="https://wa.me/9779865102989" target="_blank" title="WhatsApp"
            class="text-gray-300 hover:text-green-500 transition-colors">
            <svg class="w-7 h-7" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path
                    d="M12 2C6.477 2 2 6.477 2 12c0 1.974.551 3.829 1.551 5.433L2.5 21.5l4.133-1.051C8.171 21.449 10.026 22 12 22c5.523 0 10-4.477 10-10S17.523 2 12 2z" />
                <path d="M12 16c-1.105 0-2-.895-2-2v-4c0-1.105.895-2 2-2h4c1.105 0 2 .895 2 2v4c0 1.105-.895 2-2 2h-4z"
                    fill="currentColor" stroke="none" />
            </svg>
        </a>
    </div>

    <!-- Custom Modal/Message Box (Used for Beta Info and Search Status) -->
    <div id="beta-modal"
        class="fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4 opacity-0 pointer-events-none transition-opacity duration-300 ease-out">
        <div id="beta-modal-content"
            class="bg-[#2D2C31] p-8 rounded-xl shadow-3xl max-w-sm w-full relative border-2 border-red-500 transform scale-95 transition-all duration-300 ease-out">
            <!-- Close Button -->
            <button onclick="hideBetaModal()"
                class="absolute top-2 right-2 text-gray-400 hover:text-red-400 p-2 rounded-full transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                    xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                    </path>
                </svg>
            </button>

            <h2 id="modal-title" class="text-2xl font-bold text-red-400 mb-4">Beta Version Information</h2>
            <p id="modal-body" class="text-gray-300">
                This application is currently in **Beta Version**.
                <br><br>
                New features, updates, and improvements are actively in the developmental phase. Please be aware that
                you might encounter occasional changes or minor issues.
            </p>
        </div>
    </div>

    <!-- Loading Spinner (Hidden by default) -->
    <div id="loading-spinner"
        class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex flex-col items-center justify-center">
        <div class="animate-spin rounded-full h-32 w-32 border-b-4 border-purple-500"></div>
        <p class="text-white mt-4 text-lg">Searching the database...</p>
    </div>

    <!-- JavaScript Logic -->
    <script>
        // --- Configuration & Constants ---
        const LAST_UPDATED_TIMESTAMP_STRING = "December 04, 2025 09:30:00"; // Updated timestamp
        const QUOTE_PAUSE_TIME_MS = 10000;
        const VIDKING_BASE_URL = "https://www.vidking.net/embed/";

        // Gemini API Config
        const GEMINI_TEXT_MODEL = 'gemini-2.5-flash-preview-09-2025';
        const IMAGEN_MODEL = 'imagen-4.0-generate-001';
        const apiKey = ""; // API key is provided by the canvas environment automatically
        const GEMINI_URL = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_TEXT_MODEL}:generateContent?key=${apiKey}`;
        const IMAGEN_URL = `https://generativelanguage.googleapis.com/v1beta/models/${IMAGEN_MODEL}:predict?key=${apiKey}`;

        // Fixed set of inspirational quotes and authors
        const QUOTES = [
            { content: "The journey of a thousand miles begins with one step.", author: "Lao Tzu" },
            { content: "Believe you can and you're halfway there.", author: "Theodore Roosevelt" },
            { content: "The only way to do great work is to love what you do.", author: "Steve Jobs" },
            { content: "Success is not final, failure is not fatal: it is the courage to continue that counts.", author: "Winston Churchill" },
            { content: "Your time is limited, don't waste it living someone else's life.", author: "Steve Jobs" },
            { content: "The best time to plant a tree was 20 years ago. The second best time is now.", author: "Chinese Proverb" },
            { content: "Be yourself; everyone else is already taken.", author: "Oscar Wilde" },
            { content: "In the middle of difficulty lies opportunity.", author: "Albert Einstein" },
            { content: "It always seems impossible until itâ€™s done.", author: "Nelson Mandela" },
            { content: "Donâ€™t watch the clock; do what it does. Keep going.", author: "Sam Levenson" },
            { content: "You miss 100% of the shots you donâ€™t take.", author: "Wayne Gretzky" },
            { content: "Act as if what you do makes a difference. It does.", author: "William James" },
            { content: "Start where you are. Use what you have. Do what you can.", author: "Arthur Ashe" },
            { content: "Success usually comes to those who are too busy to be looking for it.", author: "Henry David Thoreau" },
            { content: "Happiness is not something ready made. It comes from your own actions.", author: "Dalai Lama" },
            { content: "Dream big and dare to fail.", author: "Norman Vaughan" }
        ];

        // Global element references
        let greetingTextEl, quoteContainerEl, quoteTextEl, quoteAuthorEl, englishDateCombinedEl, nepaliDateEl, timeDisplayEl, mainContentEl, headerSeparatorEl, betaModalEl, betaModalContentEl, modalTitleEl, modalBodyEl, searchInputEl, videoPlayerContainerEl, loadingSpinnerEl, suggestionsListEl;

        let quoteInterval = null;
        let currentTypingTimeout = null;
        let isQuoteRotationActive = false;
        let typingTimer; // For debouncing suggestions
        const DEBOUNCE_TIME = 500;

        // --- Utility Functions ---

        /**
         * Helper function for exponential backoff retry logic
         */
        async function fetchWithBackoff(url, options, retries = 5, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        if (response.status === 429 && i < retries - 1) { // Rate limit
                            await new Promise(resolve => setTimeout(resolve, delay));
                            delay *= 2; // Exponential backoff
                            continue;
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    if (i === retries - 1) throw error;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }
        }

        /**
         * Generates a movie poster image using the Imagen model.
         * @param {string} title - The movie title to base the prompt on.
         * @returns {Promise<string|null>} Base64 data URL of the image, or null on failure.
         */
        async function generateImage(title) {
            const imagePrompt = `A high-contrast, minimalist movie poster thumbnail for the movie '${title}', in a 16:9 aspect ratio. Focus on key visual elements.`;

            const payload = {
                instances: [{ prompt: imagePrompt }],
                parameters: { "sampleCount": 1 }
            };

            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            };

            try {
                const response = await fetchWithBackoff(IMAGEN_URL, options);
                const result = await response.json();

                if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                    // Return the image data URL
                    return `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                } else {
                    console.error("Image generation failed or returned no data:", result);
                    return null;
                }
            } catch (error) {
                console.error("Error generating image:", error);
                return null;
            }
        }

        function getGreeting() {
            const hour = new Date().getHours();
            if (hour < 5) return "Good Night! ðŸŒƒ";
            if (hour < 12) return "Good Morning! ðŸŒ…";
            if (hour < 18) return "Good Afternoon! â˜€ï¸";
            return "Good Evening! ðŸŒ™";
        }

        function getRandomQuote() {
            const currentQuoteText = quoteTextEl.textContent.replace(/"/g, '');
            const availableQuotes = QUOTES.filter(q => q.content !== currentQuoteText);
            const selectionPool = availableQuotes.length > 0 ? availableQuotes : QUOTES;
            const randomIndex = Math.floor(Math.random() * selectionPool.length);
            return selectionPool[randomIndex];
        }

        function updateTime() {
            const now = new Date();
            const timeOptions = {
                hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true
            };
            timeDisplayEl.textContent = now.toLocaleTimeString('en-US', timeOptions);
        }

        function updateDates() {
            const now = new Date();
            const combinedEnglishOptions = {
                weekday: 'long',
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            };
            englishDateCombinedEl.textContent = now.toLocaleDateString('en-US', combinedEnglishOptions);
            const DateConstructor = typeof NepaliDateConverter !== 'undefined' ? NepaliDateConverter : (typeof NepaliDate !== 'undefined' ? NepaliDate : null);

            if (DateConstructor) {
                try {
                    const nepaliDateConverter = new DateConstructor(now);
                    const nepaliDateStr = `${nepaliDateConverter.format('MMMM D, YYYY')} B.S.`;
                    nepaliDateEl.textContent = nepaliDateStr;
                    nepaliDateEl.classList.remove('text-red-500');
                    return true;
                } catch (e) {
                    console.error("Error converting to Nepali date:", e);
                    nepaliDateEl.textContent = "Nepali Date: Conversion Error.";
                    nepaliDateEl.classList.add('text-red-500');
                    return false;
                }
            } else {
                nepaliDateEl.textContent = "Nepali Date: Loading...";
                nepaliDateEl.classList.add('text-yellow-500');
                return false;
            }
        }

        function initializeDatesWithRetry() {
            const success = updateDates();
            if (success) {
                setInterval(updateDates, 60000);
            } else {
                setTimeout(initializeDatesWithRetry, 200);
            }
        }

        function startClockAndDates() {
            updateTime();
            setInterval(updateTime, 1000);
            initializeDatesWithRetry();
        }

        function typeWriter(text, element, speed = 40, callback = () => { }) {
            let i = 0;
            element.textContent = '';
            if (currentTypingTimeout) {
                clearTimeout(currentTypingTimeout);
            }
            element.style.borderColor = '#E6E1E5';

            function type() {
                if (i < text.length) {
                    element.textContent += text.charAt(i);
                    i++;
                    currentTypingTimeout = setTimeout(type, speed);
                } else {
                    currentTypingTimeout = null;
                    element.style.borderColor = 'transparent';
                    callback();
                }
            }
            type();
        }

        function displayNextQuote() {
            quoteAuthorEl.style.opacity = '0';
            quoteAuthorEl.textContent = '';

            if (currentTypingTimeout) {
                clearTimeout(currentTypingTimeout);
                currentTypingTimeout = null;
            }
            if (quoteInterval) {
                clearTimeout(quoteInterval);
                quoteInterval = null;
            }

            const quote = getRandomQuote();
            typeWriter(`"${quote.content}"`, quoteTextEl, 40, () => {
                quoteAuthorEl.textContent = `â€” ${quote.author}`;
                quoteAuthorEl.style.transition = 'opacity 0.5s ease-in 0.5s';
                quoteAuthorEl.style.opacity = '1';

                if (isQuoteRotationActive) {
                    quoteInterval = setTimeout(displayNextQuote, QUOTE_PAUSE_TIME_MS);
                }
            });
        }

        function stopQuoteRotation() {
            isQuoteRotationActive = false;
            if (quoteInterval) {
                clearTimeout(quoteInterval);
                quoteInterval = null;
            }
            if (currentTypingTimeout) {
                clearTimeout(currentTypingTimeout);
                currentTypingTimeout = null;
            }
            quoteTextEl.textContent = 'Click the greeting above to start the inspiration.';
            quoteAuthorEl.textContent = 'â€” Ready';
            quoteAuthorEl.style.opacity = '1';
        }

        function setQuoteRotationState(shouldActivate) {
            isQuoteRotationActive = shouldActivate;
            if (shouldActivate) {
                englishDateCombinedEl.classList.add('active-state');
                nepaliDateEl.classList.add('shrunk');
                headerSeparatorEl.classList.remove('opacity-0');
                mainContentEl.classList.add('active-quote-mode');
                timeDisplayEl.classList.add('active-state');
                quoteContainerEl.classList.add('active-state');
                setTimeout(displayNextQuote, 700);
            } else {
                englishDateCombinedEl.classList.remove('active-state');
                nepaliDateEl.classList.remove('shrunk');
                headerSeparatorEl.classList.add('opacity-0');
                mainContentEl.classList.remove('active-quote-mode');
                timeDisplayEl.classList.remove('active-state');
                quoteContainerEl.classList.remove('active-state');
                stopQuoteRotation();
            }
        }

        function toggleQuoteRotation() {
            setQuoteRotationState(!isQuoteRotationActive);
        }

        function resetModalContentToBeta() {
            modalTitleEl.textContent = "Beta Version Information";
            modalTitleEl.classList.remove('text-purple-400');
            modalTitleEl.classList.add('text-red-400');
            modalBodyEl.innerHTML = `
                This application is currently in **Beta Version**.
                <br><br>
                New features, updates, and improvements are actively in the developmental phase. Please be aware that you might encounter occasional changes or minor issues.
            `;
            betaModalContentEl.classList.remove('border-purple-500');
            betaModalContentEl.classList.add('border-red-500');
        }

        function showBetaModal(isBetaMode = false) {
            if (betaModalEl && betaModalContentEl) {
                if (isBetaMode) {
                    resetModalContentToBeta();
                }
                betaModalEl.classList.remove('opacity-0', 'pointer-events-none');
                betaModalContentEl.classList.remove('scale-95');
                betaModalContentEl.classList.add('scale-100');
            }
        }

        function hideBetaModal() {
            if (betaModalEl && betaModalContentEl) {
                betaModalContentEl.classList.remove('scale-100');
                betaModalContentEl.classList.add('scale-95');
                setTimeout(() => {
                    betaModalEl.classList.add('opacity-0', 'pointer-events-none');
                }, 300);
            }
        }

        function showTemporaryMessage(message, isError = false) {
            modalTitleEl.textContent = isError ? "Search Error" : "Search Status";
            modalTitleEl.classList.remove('text-red-400', 'text-purple-400');
            modalTitleEl.classList.add(isError ? 'text-red-400' : 'text-purple-400');

            modalBodyEl.innerHTML = message;

            betaModalContentEl.classList.remove('border-red-500', 'border-purple-500');
            betaModalContentEl.classList.add(isError ? 'border-red-500' : 'border-purple-500');

            showBetaModal(false);
            setTimeout(hideBetaModal, 4000);
        }

        function handleKeydown(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                handleSearch();
            }
        }

        function showLoading() {
            loadingSpinnerEl.classList.remove('hidden');
        }

        function hideLoading() {
            loadingSpinnerEl.classList.add('hidden');
        }

        // --- Gemini AI Search Logic ---

        /**
         * Uses Gemini AI with Google Search Grounding to find the TMDB ID for a query.
         */
        async function fetchTmdbIdWithAI(query) {
            // UPDATED SYSTEM PROMPT: Stricter instructions for TMDB ID lookup
            const systemPrompt = `You are an expert movie and TV database lookup service. Your task is to find the most popular and accurate The Movie Database (TMDB) ID for the exact user query. 
                You MUST use Google Search grounding to find the ID. 
                Return a single, valid JSON object that strictly adheres to the provided schema. DO NOT include any explanatory text, markdown notes, or preamble outside of the JSON block.
                Set 'type' to 'tv' if it's a series, and 'movie' if it's a film. Prioritize the newest or most popular result if multiple exist.`;

            const userQuery = `Find the TMDB ID, media type (movie or tv), and full title for the content: "${query}"`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "id": { "type": "string", "description": "The numeric TMDB ID as a string." },
                            "type": { "type": "string", "description": "The media type, either 'movie' or 'tv'." },
                            "title": { "type": "string", "description": "The accurate, full title of the content." }
                        },
                        required: ["id", "type", "title"]
                    }
                }
            };

            try {
                const response = await fetchWithBackoff(GEMINI_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (jsonText) {
                    const parsedJson = JSON.parse(jsonText);
                    if (parsedJson.id && (parsedJson.type === 'movie' || parsedJson.type === 'tv') && parsedJson.title) {
                        return parsedJson;
                    }
                }
                // If the structured response is missing or incomplete, throw an error
                throw new Error("AI returned invalid or incomplete data.");

            } catch (error) {
                console.error("Error fetching TMDB ID with AI:", error);
                // Throw a custom user-friendly error message
                throw new Error(`Could not find accurate TMDB ID for "${query}". Please try a more specific search (e.g., "Dune 2021").`);
            }
        }

        /**
         * Uses Gemini AI to fetch real-time search suggestions and generates an image for each.
         */
        async function fetchSuggestionsWithAI(query) {
            if (query.length < 3) {
                return [];
            }

            const systemPrompt = "You are a movie/series title predictor. Based on the user's partial input, generate a list of 5 popular and relevant movie or series titles. Return ONLY a JSON array of strings.";
            const userQuery = `Generate 5 suggestions for a movie or series title starting with or highly relevant to: "${query}"`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: { "type": "STRING" }
                    }
                }
            };

            try {
                const response = await fetchWithBackoff(GEMINI_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (jsonText) {
                    const titles = JSON.parse(jsonText);

                    // Generate image for each title concurrently
                    const suggestionsWithImages = await Promise.all(titles.map(async (title) => {
                        const imageUrl = await generateImage(title);
                        return { title, imageUrl };
                    }));

                    return suggestionsWithImages;
                }
                return [];

            } catch (error) {
                console.error("Error fetching suggestions:", error);
                return [];
            }
        }


        /**
         * Clears the player container and inserts the video iframe.
         */
        function loadPlayer(embedUrl, title) {
            videoPlayerContainerEl.innerHTML = '';

            const iframe = document.createElement('iframe');
            iframe.src = embedUrl;
            iframe.width = "100%";
            iframe.height = "100%";
            iframe.frameBorder = "0";
            iframe.allow = "fullscreen";
            iframe.title = `VidKing Player for ${title}`;

            videoPlayerContainerEl.appendChild(iframe);

            console.log(`Video Player loaded for: ${title}`);
        }

        /**
         * Constructs the VidKing embed URL based on the search result.
         */
        function constructEmbedUrl(result) {
            let embedPath;
            const queryParams = '?color=A78BFA&autoPlay=true'; // Custom color and autoplay

            if (result.type === 'movie') {
                embedPath = `movie/${result.id}`;
            } else if (result.type === 'tv') {
                // For TV, VidKing typically defaults to S1E1 if not specified.
                embedPath = `tv/${result.id}/1/1`;
            } else {
                return null;
            }

            return `${VIDKING_BASE_URL}${embedPath}${queryParams}`;
        }

        /**
         * Handles the main search action using the AI lookup.
         */
        async function handleSearch() {
            const query = searchInputEl.value.trim();
            renderSuggestions([]); // Hide suggestions when searching

            if (query.length === 0) {
                showTemporaryMessage("Please enter a movie or series title to search.", true);
                return;
            }

            showLoading();
            videoPlayerContainerEl.innerHTML = `<p class="video-placeholder-text">Searching for: "${query}"...</p>`;

            try {
                // 1. Fetch data from AI
                const searchResult = await fetchTmdbIdWithAI(query);

                // 2. Construct Embed URL
                const embedUrl = constructEmbedUrl(searchResult);

                if (embedUrl) {
                    // 3. Load Player
                    loadPlayer(embedUrl, searchResult.title);

                    // 4. Provide Feedback
                    let message = `Successfully found **${searchResult.title}** (${searchResult.type.toUpperCase()}) and loading player.`;
                    if (searchResult.type === 'tv') {
                        message += ` (Defaulting to S1E1)`;
                    }
                    showTemporaryMessage(message);
                } else {
                    showTemporaryMessage("Error: Could not construct a valid embed URL from AI result.", true);
                }

            } catch (error) {
                // Display the placeholder text in the player area again
                videoPlayerContainerEl.innerHTML = `<p class="video-placeholder-text">Search for a Movie or TV Series to play it here.</p>`;
                showTemporaryMessage(error.message, true);
            } finally {
                hideLoading();
            }

            // Clear input after search attempt
            searchInputEl.value = '';
        }

        // --- Suggestion UI Logic ---

        function renderSuggestions(suggestions) {
            suggestionsListEl.innerHTML = '';

            if (suggestions && suggestions.length > 0) {
                suggestions.forEach(suggestion => {
                    const li = document.createElement('li');
                    li.className = 'suggestion-item';
                    li.onclick = () => {
                        searchInputEl.value = suggestion.title;
                        renderSuggestions([]); // Clear suggestions
                        handleSearch(); // Trigger search immediately
                    };

                    const img = document.createElement('img');
                    img.className = 'suggestion-thumbnail';
                    img.src = suggestion.imageUrl || 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUAAAAEAAAABACAYAAADmEh0wAAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAQKADAAQAAAABAAAAQAAAAABFqgPPAAAAHElEQVR42mNkYGD4T4AKvEANtAAxMA+FhgMAAE8QAB8QG/LCAAAAAElFTkSuQmCC'; // Placeholder if image fails
                    img.alt = `Poster for ${suggestion.title}`;

                    const span = document.createElement('span');
                    span.textContent = suggestion.title;
                    span.classList.add('flex-grow'); // Allows text to take remaining space

                    li.appendChild(img);
                    li.appendChild(span);
                    suggestionsListEl.appendChild(li);
                });
                suggestionsListEl.classList.add('active');
            } else {
                suggestionsListEl.classList.remove('active');
            }
        }

        async function handleInput() {
            clearTimeout(typingTimer);
            const query = searchInputEl.value.trim();
            if (query.length < 3) {
                renderSuggestions([]);
                return;
            }

            // Show a temporary loading indicator immediately
            suggestionsListEl.innerHTML = `
                <li class="loading-suggestion">
                    <div class="spinner"></div>
                    Generating suggestions...
                </li>
            `;
            suggestionsListEl.classList.add('active');

            // Set a timer to fetch suggestions after DEBOUNCE_TIME
            typingTimer = setTimeout(async () => {
                const suggestions = await fetchSuggestionsWithAI(query);
                renderSuggestions(suggestions);
            }, DEBOUNCE_TIME);
        }

        // --- Initialization ---

        function initializeApp() {
            // Get DOM elements
            greetingTextEl = document.getElementById('greeting-text');
            quoteContainerEl = document.getElementById('quote-container');
            quoteTextEl = document.getElementById('quote-text');
            quoteAuthorEl = document.getElementById('quote-author');
            englishDateCombinedEl = document.getElementById('english-date-combined');
            nepaliDateEl = document.getElementById('nepali-date');
            timeDisplayEl = document.getElementById('time-display');
            mainContentEl = document.getElementById('main-content');
            headerSeparatorEl = document.getElementById('header-separator');
            betaModalEl = document.getElementById('beta-modal');
            betaModalContentEl = document.getElementById('beta-modal-content');
            modalTitleEl = document.getElementById('modal-title');
            modalBodyEl = document.getElementById('modal-body');
            searchInputEl = document.getElementById('search-input');
            videoPlayerContainerEl = document.getElementById('video-player-container');
            loadingSpinnerEl = document.getElementById('loading-spinner');
            suggestionsListEl = document.getElementById('suggestions-list');

            // Set initial greeting
            greetingTextEl.textContent = getGreeting();

            // Start the clock and date intervals
            startClockAndDates();

            // Log the update time to the console
            logLastUpdated();
        }

        /**
         * Logs the last updated timestamp to the console.
         */
        function logLastUpdated() {
            const date = new Date(LAST_UPDATED_TIMESTAMP_STRING);
            if (isNaN(date.getTime())) {
                console.error("Could not parse last updated timestamp.");
                return;
            }
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const datePart = `${year}/${month}/${day}`;
            let hours = date.getHours();
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12;
            hours = hours ? hours : 12;
            const hoursStr = String(hours).padStart(2, '0');
            const timePart = `${hoursStr}:${minutes} ${ampm}`;
            console.log(`Page Last Updated: ${datePart}-${timePart}`);
        }

        window.onload = initializeApp;

        // Expose functions globally for HTML onclick
        window.toggleQuoteRotation = toggleQuoteRotation;
        window.showBetaModal = showBetaModal;
        window.hideBetaModal = hideBetaModal;
        window.handleSearch = handleSearch;
        window.handleKeydown = handleKeydown;
        window.handleInput = handleInput;
    </script>
</body>

</html>